<!DOCTYPE html>
<html>
<head>
    <title>User Portal - Find Nearest Runner</title>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet"/>

    <style>
        body { margin:0; padding:0; font-family: Arial, sans-serif; background: #f0f0f0; }
        html { margin:0; padding:0; }
        #map { position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; z-index: 1; background: #e0e0e0; }

        #panel {
            position:absolute;
            bottom:20px;
            left:10px;
            background:white;
            padding:15px;
            z-index:1000;
            border:1px solid #ddd;
            border-radius:5px;
            font-size:14px;
            max-width:350px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            overflow-y: auto;
            max-height: 80vh;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            padding: 8px 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            border-radius: 3px 3px 0 0;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #4ecdc4;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .location-info {
            padding: 10px;
            background: #f9f9f9;
            border-left: 3px solid #4ecdc4;
            border-radius: 3px;
            margin: 8px 0;
        }

        .location-info b {
            display: block;
            color: #333;
            margin-bottom: 4px;
        }

        .location-info small {
            color: #666;
            display: block;
            font-size: 12px;
        }

        .route-info {
            padding: 10px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 3px;
            margin: 8px 0;
        }

        .route-info .distance {
            font-size: 18px;
            font-weight: bold;
            color: #d39e00;
        }

        .route-info .time {
            font-size: 16px;
            font-weight: bold;
            color: #d39e00;
            margin-top: 4px;
        }

        .status-loading {
            text-align: center;
            color: #666;
            padding: 10px;
        }

        .status-error {
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 3px;
            color: #721c24;
        }

        .status-success {
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 3px;
            color: #155724;
        }

        .marker-user {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="blue"><circle cx="12" cy="12" r="8"/></svg>');
            background-size: 100%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .marker-runner {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><circle cx="12" cy="12" r="8"/></svg>');
            background-size: 100%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .marker-destination {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="green"><circle cx="12" cy="12" r="8"/></svg>');
            background-size: 100%;
            width: 30px;
            height: 30px;
            cursor: grab;
        }

        .marker-destination:active {
            cursor: grabbing;
        }

        .coordinate-popup {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: auto;
            z-index: 2000;
            white-space: nowrap;
        }

        .copy-btn, .btn, .save-btn {
            padding: 6px 10px;
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 4px 2px;
            transition: all 0.2s;
        }

        .copy-btn:hover, .btn:hover, .save-btn:hover {
            background: #36a399;
        }

        .favorite-item {
            padding: 8px;
            background: #f5f5f5;
            border-left: 3px solid #4ecdc4;
            margin: 6px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
        }

        .favorite-actions {
            display: flex;
            gap: 4px;
        }

        .delete-btn {
            padding: 4px 8px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #ee5a52;
        }

        .go-btn {
            padding: 4px 8px;
            background: #51cf66;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .go-btn:hover {
            background: #40c057;
        }

        .instruction {
            padding: 8px;
            background: #e7f5ff;
            border-left: 3px solid #1971c2;
            border-radius: 3px;
            font-size: 12px;
            color: #0550ae;
            margin: 8px 0;
        }

        .eta-info {
            padding: 8px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 12px;
            color: #333;
            margin: 4px 0;
        }

        .input-group {
            display: flex;
            gap: 5px;
            margin: 8px 0;
        }

        .input-group input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .help-text {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        /* MapLibre GL Styles */
        .maplibregl-canvas { display: block; }
    </style>
</head>
<body>

<div id="panel">
    <b>üìç Advanced Location Finder</b>
    <hr style="margin: 8px 0;">
    
    <!-- Tabs for different views -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('route')">Route</button>
        <button class="tab-btn" onclick="switchTab('location')">Location</button>
        <button class="tab-btn" onclick="switchTab('favorites')">‚≠ê Favorites</button>
    </div>

    <!-- Route Tab -->
    <div id="route" class="tab-content active">
        <div class="instruction">
            üìç <strong>Single Click:</strong> Show coordinates<br>
            üìç <strong>Double Click:</strong> Set destination<br>
            üñ±Ô∏è <strong>Drag Green Pin:</strong> Update destination
        </div>
        <div id="info">
            <div class="status-loading">‚è≥ Finding nearest runner...</div>
        </div>
    </div>

    <!-- Location Tab -->
    <div id="location" class="tab-content">
        <div class="instruction">
            Use GPS or manually set your location
        </div>
        <button class="btn" onclick="getCurrentLocation()" style="width: 100%; margin-top: 5px;">
            üìç Get My GPS Location
        </button>
        <div id="location-display" style="margin-top: 10px;">
            <div class="status-loading">GPS Location: Not set</div>
        </div>
        <div id="selected-location" style="margin-top: 10px;"></div>
        <div class="input-group">
            <input type="text" id="location-name" placeholder="e.g., Home, Office, Gym" style="flex: 1;">
            <button class="save-btn" onclick="saveCurrentLocation()">Save</button>
        </div>
    </div>

    <!-- Favorites Tab -->
    <div id="favorites" class="tab-content">
        <div class="instruction">
            Saved favorite locations for quick access
        </div>
        <button class="btn" onclick="refreshFavorites()" style="width: 100%; margin-top: 5px;">
            üîÑ Refresh Favorites
        </button>
        <div id="favorites-list" style="margin-top: 10px;">
            <div class="status-loading">Loading favorites...</div>
        </div>
    </div>

    <div class="help-text">
        üí° Auto-refresh: Every 5 seconds
    </div>
</div>

<!-- Floating Coordinate Display (shows on map) -->
<div id="coordinate-tooltip" class="coordinate-popup" style="display: none;"></div>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

<script>

// ==================== MAP INITIALIZATION ====================

let map;

// Initialize map after document is ready
function initializeMap() {
    try {
        // Check if map container exists
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('‚ùå Map container not found');
            return;
        }
        console.log('‚úì Map container found');
        
        // Check if MapLibre GL is available
        if (typeof maplibregl === 'undefined') {
            console.error('‚ùå MapLibre GL not loaded from CDN');
            return;
        }
        console.log('‚úì MapLibre GL library loaded');
        
        // Create map instance
        map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap Contributors'
                    }
                },
                layers: [
                    {
                        id: 'osm-layer',
                        type: 'raster',
                        source: 'osm'
                    }
                ]
            },
            center: [79.4192, 13.6288],
            zoom: 13,
            attributionControl: true
        });
        console.log('‚úì Map instance created');
        
        // Set up event handlers immediately
        setupMapEventHandlers();
        console.log('‚úì Event handlers registered');
        
        // Handle map load event
        map.on('load', () => {
            console.log('‚úÖ Map tiles loaded successfully');
            findNearestRunner();
            
            // Auto-refresh route every 5 seconds
            state.etaRefreshInterval = setInterval(() => {
                findNearestRunner();
                const timeEl = document.getElementById('eta-time');
                if (timeEl) {
                    timeEl.textContent = new Date().toLocaleTimeString();
                }
            }, 5000);
        });
        
        // Handle errors
        map.on('error', function(e) {
            console.error('‚ùå Map error:', e.error || e);
        });
        
        map.on('sourcedataloading', function() {
            console.log('‚Üì Loading map tiles...');
        });
        
    } catch (error) {
        console.error('‚ùå Failed to initialize map:', error);
    }
}

// Setup all map event handlers
function setupMapEventHandlers() {
    if (!map) {
        console.error('‚ùå Map object not available for setting up event handlers');
        return;
    }
    
    // Single Click: Show coordinates
    map.on('click', function(e) {
        const lngLat = e.lngLat;
        state.lastClickCoordinates = {lat: lngLat.lat, lng: lngLat.lng};
        
        // Show tooltip at click position
        showCoordinateTooltip(lngLat, e.originalEvent.clientX, e.originalEvent.clientY);
        
        // Log coordinate on server
        logCoordinateToServer(lngLat.lat, lngLat.lng);
        
        console.log('üìç Clicked coordinates:', formatCoordinates(lngLat.lat, lngLat.lng));
    });

    // Double Click: Set destination
    map.on('dblclick', function(e) {
        const lngLat = e.lngLat;
        state.selectedLocation = {lat: lngLat.lat, lon: lngLat.lng};
        
        // Update server with new location
        updateUserLocationOnServer(lngLat.lat, lngLat.lng);
        
        // Add green destination marker
        addDestinationMarker(lngLat.lat, lngLat.lng);
        
        // Recalculate route to this new destination
        if (state.nearestRunner) {
            fetchRoute(state.userLocation.lat, state.userLocation.lon, 
                       state.nearestRunner.lat, state.nearestRunner.lon, 
                       state.nearestRunner, state.selectedLocation);
        }
        
        console.log('üìç Destination set to:', formatCoordinates(lngLat.lat, lngLat.lng));
    });
}

// ==================== STATE MANAGEMENT ====================

const state = {
    userLocation: {lat: 13.6288, lon: 79.4192},
    selectedLocation: null,
    nearestRunner: null,
    markers: {},
    routeLayer: null,
    lastClickCoordinates: null,
    etaRefreshInterval: null
};

// ==================== UI TAB MANAGEMENT ====================

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    // Load favorites when favorites tab is opened
    if (tabName === 'favorites') {
        refreshFavorites();
    }
}

// ==================== COORDINATE DISPLAY UTILITIES ====================

/**
 * Format coordinates as "Lat: xx.xxxxx, Lng: xx.xxxxx"
 */
function formatCoordinates(lat, lon) {
    return `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
}

/**
 * Display coordinate tooltip at map position
 */
function showCoordinateTooltip(lngLat, clientX, clientY) {
    const tooltip = document.getElementById('coordinate-tooltip');
    const text = formatCoordinates(lngLat.lat, lngLat.lng);
    
    tooltip.innerHTML = `
        ${text}<br>
        <button class="copy-btn" onclick="copyToClipboard('${lngLat.lat.toFixed(6)}, ${lngLat.lng.toFixed(6)}')">Copy</button>
    `;
    tooltip.style.display = 'block';
    tooltip.style.left = (clientX + 10) + 'px';
    tooltip.style.top = (clientY + 10) + 'px';
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        tooltip.style.display = 'none';
    }, 3000);
}

/**
 * Copy text to clipboard
 */
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('‚úì Coordinates copied!');
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

// ==================== MAP EVENT HANDLERS ====================

/**
 * Single Click: Show coordinates in tooltip
 */
// NOTE: This handler is now set up in setupMapEventHandlers() called during map initialization

// ==================== MARKER MANAGEMENT ====================

/**
 * Add draggable destination marker (green)
 */
function addDestinationMarker(lat, lon) {
    // Remove old destination marker if exists
    if (state.markers.destination) {
        state.markers.destination.remove();
    }
    
    const el = document.createElement('div');
    el.className = 'marker-destination';
    
    const marker = new maplibregl.Marker({
        element: el,
        draggable: true
    })
        .setLngLat([lon, lat])
        .addTo(map);
    
    // Handle drag end - update route
    marker.on('dragend', function() {
        const newLngLat = marker.getLngLat();
        state.selectedLocation = {lat: newLngLat.lat, lon: newLngLat.lng};
        
        // Update server
        updateUserLocationOnServer(newLngLat.lat, newLngLat.lng);
        
        // Recalculate route
        if (state.nearestRunner) {
            fetchRoute(state.userLocation.lat, state.userLocation.lon,
                      state.nearestRunner.lat, state.nearestRunner.lon,
                      state.nearestRunner, state.selectedLocation);
        }
        
        console.log('üìç Marker dragged to:', formatCoordinates(newLngLat.lat, newLngLat.lng));
    });
    
    state.markers.destination = marker;
}

/**
 * Add user location marker (blue)
 */
function addUserMarker(lat, lon) {
    if (state.markers.user) {
        state.markers.user.remove();
    }
    
    const el = document.createElement('div');
    el.className = 'marker-user';
    
    const marker = new maplibregl.Marker(el)
        .setLngLat([lon, lat])
        .setPopup(new maplibregl.Popup().setHTML('<b>üìç Your Location</b>'))
        .addTo(map);
    
    state.markers.user = marker;
}

/**
 * Add runner marker (red)
 */
function addRunnerMarker(lat, lon, name, runnerId) {
    if (state.markers.runner) {
        state.markers.runner.remove();
    }
    
    const el = document.createElement('div');
    el.className = 'marker-runner';
    
    const marker = new maplibregl.Marker(el)
        .setLngLat([lon, lat])
        .setPopup(new maplibregl.Popup().setHTML(`<b>üö¥ ${name}</b><br>Status: Active`))
        .addTo(map);
    
    state.markers.runner = marker;
}

// ==================== ROUTE CALCULATION ====================

async function findNearestRunner() {
    try {
        const response = await fetch(
            `/api/user/nearest-runner?lat=${state.userLocation.lat}&lng=${state.userLocation.lon}`
        );
        
        if (!response.ok) {
            document.getElementById('info').innerHTML = '<div class="status-error">‚ùå Could not find runner</div>';
            return;
        }
        
        const data = await response.json();
        const runner = data.runner;
        const distance = data.distance_km;
        
        state.nearestRunner = runner;

        // Add user marker
        addUserMarker(state.userLocation.lat, state.userLocation.lon);
        
        // Add runner marker
        addRunnerMarker(runner.lat, runner.lon, runner.name, runner.id);
        
        // Fetch and draw route
        if (!state.selectedLocation) {
            state.selectedLocation = {lat: runner.lat, lon: runner.lon};
        }
        
        fetchRoute(state.userLocation.lat, state.userLocation.lon, 
                   runner.lat, runner.lon, runner, distance);
        
    } catch (error) {
        console.error('Error finding nearest runner:', error);
        document.getElementById('info').innerHTML = '<div class="status-error">‚ùå Error: ' + error.message + '</div>';
    }
}

async function fetchRoute(startLat, startLng, endLat, endLng, runner, selectedDistance) {
    try {
        const response = await fetch(
            `/api/route?start_lat=${startLat}&start_lng=${startLng}&end_lat=${endLat}&end_lng=${endLng}`
        );
        const routeData = await response.json();

        if (routeData.success && routeData.route) {
            const route = routeData.route;

            // Remove old route layer
            if (map.getLayer('route-layer')) {
                map.removeLayer('route-layer');
            }
            if (map.getSource('route')) {
                map.removeSource('route');
            }

            // Add new route
            map.addSource('route', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: route.geometry
                }
            });

            map.addLayer({
                id: 'route-layer',
                type: 'line',
                source: 'route',
                paint: {
                    'line-width': 4,
                    'line-color': '#2196F3'
                }
            });

            // Fit map to route
            const bounds = turf_bbox(route.geometry);
            if (bounds) {
                map.fitBounds(bounds, { padding: 50 });
            }

            // Update info panel
            const routeInfo = `
                <div class="location-info">
                    <b>üìç Your Location</b>
                    <small>${state.userLocation.lat.toFixed(6)}, ${state.userLocation.lon.toFixed(6)}</small>
                </div>
                <div class="location-info">
                    <b>üö¥ ${runner.name}</b>
                    <small>ID: ${runner.id} | Active</small>
                    <small>${runner.lat.toFixed(6)}, ${runner.lon.toFixed(6)}</small>
                </div>
                ${state.selectedLocation && (state.selectedLocation.lat !== runner.lat || state.selectedLocation.lon !== runner.lon) ? `
                <div class="location-info">
                    <b>üìç Your Selected Destination</b>
                    <small>${state.selectedLocation.lat.toFixed(6)}, ${state.selectedLocation.lon.toFixed(6)}</small>
                </div>
                ` : ''}
                <div class="route-info">
                    <div><b>üõ£Ô∏è Route Details</b></div>
                    <div class="distance">üìè ${route.distance_km.toFixed(2)} km</div>
                    <div class="time">‚è±Ô∏è ~${Math.ceil(route.duration_min)} mins</div>
                </div>
                <div class="eta-info">
                    Last updated: <span id="eta-time">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            document.getElementById('info').innerHTML = routeInfo;
            
        } else {
            // Fallback to simple distance
            const distance = typeof selectedDistance === 'object' ? selectedDistance.distance_km : selectedDistance;
            document.getElementById('info').innerHTML = `
                <div class="location-info">
                    <b>üìç Your Location</b>
                    <small>${state.userLocation.lat.toFixed(6)}, ${state.userLocation.lon.toFixed(6)}</small>
                </div>
                <div class="location-info">
                    <b>üö¥ ${runner.name}</b>
                    <small>ID: ${runner.id}</small>
                </div>
                <div class="route-info">
                    <b>üìè Distance: ${distance.toFixed(2)} km</b>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error fetching route:', error);
    }
}

// ==================== GEOLOCATION ====================

async function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('‚ùå Geolocation not supported in your browser');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const {latitude, longitude} = position.coords;
            state.userLocation = {lat: latitude, lon: longitude};
            
            // Update UI
            document.getElementById('location-display').innerHTML = `
                <div class="status-success">
                    ‚úì GPS Location Found<br>
                    <small>${latitude.toFixed(6)}, ${longitude.toFixed(6)}</small>
                </div>
            `;
            
            // Move map to new location
            map.flyTo({center: [longitude, latitude], zoom: 15, duration: 1000});
            
            // Update user marker
            addUserMarker(latitude, longitude);
            
            // Recalculate nearest runner
            findNearestRunner();
        },
        function(error) {
            alert('‚ùå GPS access denied or unavailable: ' + error.message);
        }
    );
}

// ==================== SAVED LOCATIONS ====================

async function saveCurrentLocation() {
    const locationName = document.getElementById('location-name').value.trim();
    
    if (!locationName) {
        alert('‚ö†Ô∏è Enter a name for this location');
        return;
    }
    
    if (!state.selectedLocation) {
        alert('‚ö†Ô∏è No location selected yet. Double-click on map first.');
        return;
    }
    
    try {
        const response = await fetch('/api/user/locations/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: locationName,
                latitude: state.selectedLocation.lat,
                longitude: state.selectedLocation.lon,
                created_at: new Date().toISOString()
            })
        });
        
        if (response.ok) {
            alert(`‚úì "${locationName}" saved!`);
            document.getElementById('location-name').value = '';
            refreshFavorites();
        } else {
            alert('‚ùå Failed to save location');
        }
    } catch (error) {
        console.error('Error saving location:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

async function refreshFavorites() {
    try {
        const response = await fetch('/api/user/locations/saved');
        const locations = await response.json();
        
        const listEl = document.getElementById('favorites-list');
        
        if (locations.length === 0) {
            listEl.innerHTML = '<div class="status-loading">No saved locations yet</div>';
            return;
        }
        
        listEl.innerHTML = locations.map(loc => `
            <div class="favorite-item">
                <span class="favorite-name">${loc.name}</span>
                <div class="favorite-actions">
                    <button class="go-btn" onclick="goToLocation(${loc.latitude}, ${loc.longitude}, '${loc.name}')">Go</button>
                    <button class="delete-btn" onclick="deleteSavedLocation('${loc.name}')">‚úï</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error refreshing favorites:', error);
        document.getElementById('favorites-list').innerHTML = '<div class="status-error">‚ùå Error loading favorites</div>';
    }
}

function goToLocation(lat, lon, name) {
    state.selectedLocation = {lat, lon};
    map.flyTo({center: [lon, lat], zoom: 15, duration: 1000});
    addDestinationMarker(lat, lon);
    
    if (state.nearestRunner) {
        fetchRoute(state.userLocation.lat, state.userLocation.lon,
                  state.nearestRunner.lat, state.nearestRunner.lon,
                  state.nearestRunner, null);
    }
    
    alert(`üìç Going to "${name}"`);
}

async function deleteSavedLocation(name) {
    if (!confirm(`Delete "${name}"?`)) return;
    
    try {
        const response = await fetch(`/api/user/locations/${encodeURIComponent(name)}`, {method: 'DELETE'});
        
        if (response.ok) {
            refreshFavorites();
        } else {
            alert('‚ùå Failed to delete location');
        }
    } catch (error) {
        console.error('Error deleting location:', error);
    }
}

// ==================== SERVER API CALLS ====================

async function logCoordinateToServer(lat, lng) {
    try {
        await fetch(`/api/coordinates/log?lat=${lat}&lng=${lng}`);
    } catch (error) {
        console.error('Error logging coordinate:', error);
    }
}

async function updateUserLocationOnServer(lat, lng) {
    try {
        await fetch('/api/user/location', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({latitude: lat, longitude: lng})
        });
    } catch (error) {
        console.error('Error updating location:', error);
    }
}

// ==================== UTILITY FUNCTIONS ====================

function turf_bbox(geometry) {
    if (!geometry || !geometry.coordinates) return null;
    let minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
    
    const coords = geometry.coordinates;
    coords.forEach(coord => {
        if (coord[0] < minLng) minLng = coord[0];
        if (coord[0] > maxLng) maxLng = coord[0];
        if (coord[1] < minLat) minLat = coord[1];
        if (coord[1] > maxLat) maxLat = coord[1];
    });
    
    return [[minLng, minLat], [maxLng, maxLat]];
}

// ==================== AUTO-REFRESH & INITIALIZATION ====================

// Initialize map when page loads
function start() {
    console.log('üìç Starting map initialization...');
    console.log('Document ready state:', document.readyState);
    initializeMap();
}

if (document.readyState === 'loading') {
    console.log('‚è≥ Waiting for DOM to load...');
    document.addEventListener('DOMContentLoaded', start);
} else {
    console.log('üìÑ DOM already loaded');
    // Give MapLibre GL library a moment to be sure it's ready
    setTimeout(start, 100);
}
